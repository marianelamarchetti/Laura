<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel de Administración con imagen</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <button class="boton-volver-inicio" onclick="window.location.href='/admin-login.html'">Cerrar Sesión</button>
  <button class="boton-volver-inicio" onclick="window.location.href='/panel_productos.html'">Productos</button>
  <button class="boton-volver-inicio" onclick="window.location.href='/panel_categorias.html'">Categorías</button>
  <h1 class="h1-panel-adm">Panel de Administración</h1>

  <!-- Selección de categoría -->
  <label for="categorySelect" class="label-panel-adm">Seleccionar categoría:</label>
  <select class="category-select" id="categorySelect">
    <option value="velas">Velas</option>
    <option value="sahumerios">Souvenir velitas</option>
    <option value="perfumes">Sahumerios</option>
    <option value="souvenir">Aromatizantes</option>
  </select>

  <h2 class="h2-panel-adm">Gestión de productos</h2>

  <div class="admin-panel-content">
    <!-- Lista de productos -->
    <div class="products-container">
      <table class="products-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Precio</th>
            <th>Imagen</th>
            <th>Categoría</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Formulario de producto -->
    <form class="product-form">
      <input type="hidden" class="edit-id" />
      <input type="text" class="product-name" placeholder="Nombre del producto" required />
      <input type="number" class="product-price" placeholder="Precio" step="0.01" required />
      <br /><br />
      <select class="product-category" required>
        <option value="sahumerios">Sahumerios</option>
        <option value="velas">Velas</option>
        <option value="perfumes">Perfumes</option>
        <option value="souvenir">Souvenir</option>
        <option value="aromatizantes">Aromatizantes</option>
      </select>
      <br /><br />      
      <label for="productImageFile" class="label-form"></label>
      <input type="file" class="product-image-file" accept="image/*" />
      <br /><br />
      <button type="submit" class="buton-panel-adm">Guardar</button>
    </form>    
  </div>

  <script>
    // Obtener token globalmente
    const token = localStorage.getItem("token");
    if (!token) {
      alert("No estás logueado");
      window.location.href = "admin-login.html";
    }

    document.addEventListener("DOMContentLoaded", async () => {
      try {
        const res = await fetch("http://localhost:3000/admin/protegido", {
          headers: {
            Authorization: "Bearer " + token
          }
        });

        if (!res.ok) {
          throw new Error("Token inválido");
        }

        const data = await res.json();
        console.log("Acceso autorizado:", data.message);
      } catch (err) {
        alert("Token inválido o expirado. Por favor, iniciá sesión de nuevo.");
        localStorage.removeItem("token");
        window.location.href = "admin-login.html";
      }
    });

    let currentCategory = "velas";
    const categorySelect = document.querySelector(".category-select");
    const productsTable = document.querySelector(".products-table tbody");
    const productForm = document.querySelector(".product-form");
    const productName = document.querySelector(".product-name");
    const productPrice = document.querySelector(".product-price");
    const editId = document.querySelector(".edit-id");
    const productImageFile = document.querySelector(".product-image-file");

    // Cambiar categoría
    categorySelect.addEventListener("change", () => {
      currentCategory = categorySelect.value;
      loadProducts();
      resetForm();
    });

    // Cargar productos
    async function loadProducts() {
      try {
        const res = await fetch(`http://localhost:3000/productos/${currentCategory}`);
        if (!res.ok) throw new Error('Error cargando productos');
        const productos = await res.json();

        productsTable.innerHTML = "";
        productos.forEach(p => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${p.nombre}</td>
            <td>$${p.precio.toFixed(2)}</td>
            <td>${p.imagen ? `<img src="/uploads/${p.imagen}" alt="${p.nombre}" width="50" />` : 'Sin imagen'}</td>
            <td>${p.categoria}</td>
            <td>
              <button onclick='editProduct(${JSON.stringify(p)})'>Editar</button>
              <button onclick='deleteProduct(${p.id})'>Eliminar</button>
            </td>
          `;
          productsTable.appendChild(row);
        });
      } catch (e) {
        alert(e.message);
      }
    }

    // Editar producto
    function editProduct(p) {
      productName.value = p.nombre;
      productPrice.value = p.precio;
      editId.value = p.id;
      productImageFile.value = "";
    }

    // Eliminar producto
    async function deleteProduct(id) {
      if (!confirm('¿Querés eliminar este producto?')) return;
      try {
        const res = await fetch(`http://localhost:3000/admin/productos/${id}`, {
          method: "DELETE",
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Error eliminando producto');
        loadProducts();
        resetForm();
      } catch (e) {
        alert(e.message);
      }
    }

    // Guardar producto
    productForm.addEventListener("submit", async e => {
      e.preventDefault();

      const formData = new FormData();
      formData.append("nombre", productName.value);
      formData.append("precio", productPrice.value);
      formData.append("categoria", currentCategory);

      if (productImageFile.files.length > 0) {
        formData.append("imagen", productImageFile.files[0]);
      }

      try {
        let res;
        if (editId.value) {
          res = await fetch(`http://localhost:3000/admin/productos/${editId.value}`, {
            method: "PUT",
            headers: { 'Authorization': 'Bearer ' + token },
            body: formData
          });
        } else {
          res = await fetch("http://localhost:3000/admin/productos", {
            method: "POST",
            headers: { 'Authorization': 'Bearer ' + token },
            body: formData
          });
        }
        if (!res.ok) throw new Error("Error guardando producto");
        resetForm();
        loadProducts();
      } catch (e) {
        alert(e.message);
      }
    });

    function resetForm() {
      productForm.reset();
      editId.value = "";
      productImageFile.value = "";
    }

    // Inicializar
    categorySelect.value = currentCategory;
    loadProducts();
  </script>
</body>
</html>
